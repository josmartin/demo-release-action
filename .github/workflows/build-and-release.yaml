---
name: "build-and-release"

on:
  workflow_call:
    inputs:
      dist-base:
        required: true
        type: string
      dist-tag:
        required: true
        type: string

# concurrency:
#   group: build-and-release
#   cancel-in-progress: false

jobs:
  build:
    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout source code"
        uses: "actions/checkout@v2.3.4"

      - name: "Build & test"
        run: |
          DOCKER_BUILDKIT=1 docker build --output type=local,dest=. --build-arg NAME=${{ inputs.dist-base }}:${{ inputs.dist-tag }}.test .

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: my-artifact
          path: |
            build/*.test


      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.dist-base }}-${{ inputs.dist-tag }}
          name: "NAME: ${{ inputs.dist-base }}-${{ inputs.dist-tag }}"
          prerelease: false
          draft: false
          generate_release_notes: false
          files: |
            build/*.test
